<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poster App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet" />
    <!-- <link rel = "stylesheet" href = "assets/main.css" /> -->
</head>

<body class="bg-black">
    <main
        class="mx-auto border-r-2 border-l-2 border-slate-700 overflow-y-auto relative text-white min-h-[100vh] max-w-[900px] w-full">
        <div
            class="border-b-2 border-slate-700 p-4 flex justify-between bg-black items-center fixed top-0  bg-black max-w-[895px] w-full  ">
            <h3 class="text-2xl font-medium">Post And Comment App</h3>
            <p class="flex gap-2 cursor-pointe items-center font-mediumr" id = "user"><a href="/login">Login</a></p>
        </div>
        <form id="post-form"
            class="p-4 sticky flex flex-col mt-[4rem] top-0  items-start gap-3  border-b-2 border-slate-700">
            <textarea name="post" id="post" required class="w-full p-2 bg-transparent text-lg"
                placeholder="What are you feeling today?"></textarea>
            <button type="submit" class="p-3 w-full bg-indigo-400 text-lg font-medium">
                <i class="ri-send-plane-fill"></i>
                Post</button>
        </form>
        <div id="root" class="flex flex-col">
        </div>
        </div>
    </main>
</body>
<script type="text/javascript">
    const userpanel = document.getElementById("user")
    const root = document.getElementById("root")
    const fetchPosts = async () => {
        const response = await fetch("/post")
        const data = await response.json()
        const { posts } = data
        console.log(posts)
        posts.reverse().map((x, i) => {
            container = createPostElement(x)
            root.appendChild(container)
        })

    }
    const getUserDetails = async()=>{
        const res = await fetch('/auth/details')
        if(res.status===200){
            const result = await res.json()
            userpanel.innerHTML = `<img src="${result.user.image}" class="rounded-full h-10 w-10 object-cover" alt="avatar">${result.user.name} <i onclick = "logout()" class="ri-logout-box-r-line cursor-pointer"></i>`
        }
    }
    getUserDetails()
    fetchPosts()

    const logout = async () => {
        await fetch("/auth/logout", {
            method: "POST"
        })
    }

    const getdateString = (dateString) => {
        const date = new Date(dateString)
        const year = date.getFullYear()
        const month = ("0" + (date.getMonth() + 1)).slice(-2)
        const day = ("0" + date.getDate()).slice(-2)
        return `${day}/${month}/${year}`
    }

    const createPostElement = (post) => {
        const container = document.createElement('div')
        container.classList.add('flex', 'flex-col', 'p-4', 'gap-2', 'border-b-2', 'border-slate-700')

        const authorInfo = document.createElement('p')
        authorInfo.classList.add('text-lg', 'font-semibold', 'flex', 'items-center', 'gap-2')
        const dateString = getdateString(post.createdAt)
        
        authorInfo.innerHTML = `<img src="${post.author.image}" class="rounded-full h-10 w-10 object-cover" alt="avatar">${post.author.name} posted <p class = "ml-auto">${dateString}</p>`

        container.appendChild(authorInfo)

        const content = document.createElement('div')
        content.textContent = post.content
        container.append(content)

        const commentForm = document.createElement('form')
        commentForm.id = 'commentForm';
        commentForm.classList.add('flex', 'gap-2', 'mt-2')
        commentForm.addEventListener('submit', async function (e) {
            e.preventDefault()
            const formdata = new FormData(this)
            const comment = formdata.get("comment")
            const payload = {
                comment,
                id: post._id
            }
            const res = await fetch('/comment/create', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
            if (res.status === 200) {
                window.location.reload()
            }
        })
        commentForm.innerHTML = `
        <input type="text" required placeholder="Comment something..." name="comment" id="comment"
            class="w-full bg-transparent border-2 border-slate-700 p-2 text-lg font-medium" />
        <button type="submit" class="bg-indigo-400 w-[50px]"><i class="ri-send-plane-fill"></i></button>`

        container.appendChild(commentForm)

        const commentsSection = document.createElement('div');
        commentsSection.classList.add('flex', 'flex-col', 'gap-2');
        const commentsTitle = document.createElement('p');
        commentsTitle.classList.add('text-lg', 'font-semibold', 'mb-2');
        commentsTitle.textContent = 'Comments';
        commentsSection.appendChild(commentsTitle);
        container.appendChild(commentsSection);

        post.comments.forEach(comment => {
            const commentContainer = document.createElement('div')
            commentContainer.classList.add('flex', 'flex-col', 'gap-2')
            const commentAuthor = document.createElement('p');
            commentAuthor.classList.add('text-lg', 'font-semibold', 'flex', 'items-center', 'gap-2')
            const dateString = getdateString(comment.createdAt)
            commentAuthor.innerHTML = `<img src="${comment.author.image}" class="rounded-full h-10 w-10 object-cover" alt="avatar"> ${comment.author.name} commented <p class = "ml-auto">${dateString}</p>`
            commentContainer.appendChild(commentAuthor)

            const commentContent = document.createElement('div')
            commentContent.textContent = comment.text
            commentContainer.appendChild(commentContent)

            commentsSection.appendChild(commentContainer)
        })

        container.appendChild(commentsSection)

        return container
    }
    const form = document.getElementById("post-form")
    form.addEventListener('submit', async function (e) {
        e.preventDefault()
        const formdata = new FormData(this)
        const payload = {
            content: formdata.get("post")
        }
        const res = await fetch('/post/create', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        })
        if (res.status === 200) {
            window.location.reload()
        } else if (res.status == 401) {
            window.location.href = "/login"
        } else {
            console.error('Error:', res.statusText)
        }
    })

</script>

</html>